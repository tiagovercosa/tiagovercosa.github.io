{{ if or .Params.mastodon_id .Params.bluesky_id }}
<section class="social-comments hx:mt-12 hx:pt-6 hx:border-t hx:border-gray-200 dark:hx:border-neutral-800">
  <h2 class="hx:text-2xl hx:font-bold hx:mb-6">Comentários</h2>
  
  <div id="comments-status" class="hx:text-sm hx:text-gray-500 hx:mb-4">
    Carregando interações...
  </div>

  {{ if .Params.mastodon_id }}
  <div id="mastodon-comments" class="comment-section hx:mb-8" style="display:none;">
    <h3 class="hx:font-semibold hx:mb-2 hx:flex hx:items-center hx:gap-2">
      {{ partial "utils/icon.html" (dict "name" "mastodon" "attributes" "height=1.2em") }} 
      No Mastodon
    </h3>
    <p class="hx:text-sm hx:mb-4 hx:text-gray-600 dark:hx:text-gray-400">
      Responda a <a href="https://{{ site.Params.social_comments.mastodon.host }}/@{{ site.Params.social_comments.mastodon.username }}/{{ .Params.mastodon_id }}" target="_blank" class="hx:underline">este post</a> para aparecer aqui.
    </p>
    <div id="mastodon-replies" class="hx:space-y-4"></div>
  </div>
  {{ end }}

  {{ if .Params.bluesky_id }}
  <div id="bluesky-comments" class="comment-section" style="display:none;">
    <h3 class="hx:font-semibold hx:mb-2 hx:flex hx:items-center hx:gap-2">
      {{ partial "utils/icon.html" (dict "name" "bluesky" "attributes" "height=1.2em") }} 
      No Bluesky
    </h3>
    <p class="hx:text-sm hx:mb-4 hx:text-gray-600 dark:hx:text-gray-400">
      Responda a <a href="https://bsky.app/profile/{{ site.Params.social_comments.bluesky.did }}/post/{{ .Params.bluesky_id }}" target="_blank" class="hx:underline">este post</a> para aparecer aqui.
    </p>
    <div id="bluesky-replies" class="hx:space-y-4"></div>
  </div>
  {{ end }}

</section>

<script>
  const escapeHtml = (unsafe) => {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  // --- MASTODON ---
  {{ if .Params.mastodon_id }}
  (async () => {
    const host = "{{ site.Params.social_comments.mastodon.host }}";
    const id = "{{ .Params.mastodon_id }}";
    const container = document.getElementById('mastodon-replies');
    const section = document.getElementById('mastodon-comments');

    try {
      const response = await fetch(`https://${host}/api/v1/statuses/${id}/context`);
      if (!response.ok) throw new Error("Falha ao buscar Mastodon: " + response.status);
      const data = await response.json();
      
      if(data.descendants && data.descendants.length > 0) {
        section.style.display = 'block';
        data.descendants.forEach(reply => {
            if(reply.visibility !== 'public') return;

            const div = document.createElement('div');
            div.className = "hx:p-4 hx:rounded-lg hx:bg-gray-50 dark:hx:bg-neutral-900";
            div.innerHTML = `
              <div class="hx:flex hx:items-center hx:gap-2 hx:mb-2">
                <img src="${escapeHtml(reply.account.avatar)}" class="hx:w-8 hx:h-8 hx:rounded-full" style="width: 32px !important; height: 32px !important; min-width: 32px;" loading="lazy">
                <a href="${reply.account.url}" target="_blank" class="hx:font-medium hx:text-sm hx:hover:underline">
                  ${escapeHtml(reply.account.display_name || reply.account.username)}
                </a>
                <span class="hx:text-xs hx:text-gray-500">${new Date(reply.created_at).toLocaleDateString()}</span>
              </div>
              <div class="hx:text-sm prose dark:prose-invert max-w-none">
                ${reply.content}
              </div>
            `;
            container.appendChild(div);
        });
      } else {
        section.style.display = 'block';
        container.innerHTML = '<p class="hx:text-sm hx:italic">Sem comentários ainda.</p>';
      }
    } catch (e) {
      console.error("Erro Mastodon:", e);
      container.innerHTML = '<p class="hx:text-xs hx:text-red-500">Erro ao carregar Mastodon. Verifique o console.</p>';
      section.style.display = 'block';
    }
  })();
  {{ end }}

  // --- BLUESKY ---
  {{ if .Params.bluesky_id }}
  (async () => {
    const did = "{{ site.Params.social_comments.bluesky.did }}";
    const postId = "{{ .Params.bluesky_id }}";
    const container = document.getElementById('bluesky-replies');
    const section = document.getElementById('bluesky-comments');
    
    const atUri = `at://${did}/app.bsky.feed.post/${postId}`;
    const apiUrl = `https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri=${encodeURIComponent(atUri)}&depth=1`;

    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error("Falha ao buscar Bluesky");
      const data = await response.json();
      
      if (data.thread && data.thread.replies && data.thread.replies.length > 0) {
        section.style.display = 'block';
        const replies = data.thread.replies.sort((a, b) => (b.post.likeCount || 0) - (a.post.likeCount || 0));

        replies.forEach(reply => {
            if(!reply.post) return;
            const author = reply.post.author;
            const record = reply.post.record;

            const div = document.createElement('div');
            div.className = "hx:p-4 hx:rounded-lg hx:bg-gray-50 dark:hx:bg-neutral-900";
            div.innerHTML = `
              <div class="hx:flex hx:items-center hx:gap-2 hx:mb-2">
                <img src="${escapeHtml(author.avatar)}" class="hx:w-8 hx:h-8 hx:rounded-full" style="width: 32px !important; height: 32px !important; min-width: 32px;" loading="lazy">
                <a href="https://bsky.app/profile/${author.handle}" target="_blank" class="hx:font-medium hx:text-sm hx:hover:underline">
                  ${escapeHtml(author.displayName || author.handle)}
                </a>
                <span class="hx:text-xs hx:text-gray-500">${new Date(record.createdAt).toLocaleDateString()}</span>
              </div>
              <div class="hx:text-sm prose dark:prose-invert max-w-none">
                <p>${escapeHtml(record.text)}</p>
              </div>
              <div class="hx:mt-2 hx:flex hx:gap-3 hx:text-xs hx:text-gray-500">
                 <span>❤️ ${reply.post.likeCount || 0}</span>
              </div>
            `;
            container.appendChild(div);
        });
      } else {
        section.style.display = 'block';
        container.innerHTML = '<p class="hx:text-sm hx:italic">Sem comentários ainda.</p>';
      }
    } catch (e) {
      console.error("Erro Bluesky:", e);
    }
    document.getElementById('comments-status').style.display = 'none';
  })();
  {{ end }}
</script>
{{ end }}